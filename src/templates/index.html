<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Education Platform UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      /* Web3 Color Palette: */
      :root {
        --color-bg-dark: #101014; /* Deep Black/Blue */
        --color-bg-card: #1c1c21; /* Slightly lighter card background */
        --color-text-light: #e0e0e0; /* Light Gray text */
        --color-accent-purple: #7928ca; /* Neon Purple */
        --color-accent-cyan: #ff0080; /* Neon Pink/Cyan for contrast */
        --color-success: #38bdf8; /* Bright Blue for success */
        --color-error: #ef4444; /* Standard Red for error */
        --color-warning: #facc15; /* Bright Yellow for warning */
      }

      /* --- GLOBAL STYLES --- */
      body {
        font-family: 'Inter', sans-serif; /* Modern, geometric font */
        margin: 0;
        min-height: 100vh;
        background-color: var(--color-bg-dark); /* Dark Mode Background */
        color: var(--color-text-light);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 50px;
      }
      .container {
        width: 100%;
        max-width: 700px; /* Slightly wider */
        background: var(--color-bg-card); /* Dark card background */
        padding: 30px;
        border-radius: 16px; /* Larger border radius */
        /* Subtle glow effect instead of hard shadow */
        box-shadow: 0 0 40px rgba(121, 40, 202, 0.15); 
        border: 1px solid #333;
      }
      
      /* --- HEADER --- */
      h1 {
        text-align: center;
        color: var(--color-text-light);
        font-size: 2em;
        margin-bottom: 5px;
        /* Gradient underline for Web3 feel */
        border-bottom: 2px solid;
        border-image: linear-gradient(to right, var(--color-accent-purple), var(--color-accent-cyan)) 1;
        padding-bottom: 10px;
        font-weight: 700;
      }
      .intro-text {
        color: #a0a0a0;
        font-size: 0.9em;
        margin-bottom: 25px;
        line-height: 1.5;
        text-align: center;
      }

      /* --- CHAT AREA --- */
      #chat-area {
        border: 1px solid #333;
        height: 400px; /* Taller chat area */
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 20px;
        background: #15151a; /* Slightly darker than card */
        border-radius: 10px;
        scroll-behavior: smooth;
      }
      
      /* --- INPUT FORM --- */
      #input-form {
        display: flex;
        gap: 10px;
      }
      .user-input {
        flex-grow: 1;
        padding: 14px;
        border: 1px solid #444;
        border-radius: 8px;
        font-size: 1em;
        background: #25252a; /* Input background */
        color: var(--color-text-light);
        transition: border-color 0.3s;
      }
      .user-input::placeholder {
        color: #777;
      }
      .user-input:focus {
        border-color: var(--color-accent-purple);
        outline: none;
      }

      /* Submit Button with Gradient */
      .submit-btn {
        width: 120px;
        padding: 14px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        /* Web3 Gradient */
        background: linear-gradient(90deg, var(--color-accent-purple), var(--color-accent-cyan));
        transition: opacity 0.3s;
        text-transform: uppercase;
      }
      .submit-btn:hover {
        opacity: 0.9;
      }
      
      /* --- MESSAGE BOXES (Web3 Style) --- */
      .message-box {
        margin: 10px 0;
        padding: 12px 15px;
        border-radius: 8px;
        word-wrap: break-word;
        font-size: 0.9em;
        line-height: 1.4;
      }

      /* 1. SYSTEM/SUCCESS Messages (Status 200 OK) - Bright Blue */
      .message-success {
        background-color: rgba(56, 189, 248, 0.1);
        color: var(--color-success);
        border-left: 4px solid var(--color-success);
      }
      
      /* 2. ERROR Messages (Status 400, Network Error) - Red */
      .message-error, .message-wrong {
        background-color: rgba(239, 68, 68, 0.1);
        color: var(--color-error);
        border-left: 4px solid var(--color-error);
      }
      
      /* 3. User's Input - Subtle Right-Aligned Message */
      .user-message {
        background-color: #2a2a33;
        color: var(--color-text-light);
        text-align: right;
        margin-left: 20%;
        border-right: 4px solid var(--color-accent-purple);
        border-left: none; /* Override default */
      }
      
      /* 4. Tutor Questions - Emphasized by Purple Accent */
      .message-question {
        background-color: rgba(121, 40, 202, 0.1);
        color: #d1b7ff; /* Light purple text */
        border-left: 4px solid var(--color-accent-purple);
      }

      /* 5. Tutor Informational/System Messages - Cyan Accent */
      .message-system, .tutor-output-message {
        background-color: rgba(255, 0, 128, 0.1);
        color: #ffb3d9; /* Light pink/cyan text */
        border-left: 4px solid var(--color-accent-cyan);
      }

      /* Responsive Adjustments */
      @media (max-width: 600px) {
        body {
          padding-top: 10px;
        }
        .container {
          padding: 15px;
          margin: 10px;
        }
        #input-form {
          flex-direction: column;
        }
        .user-input {
          width: 100%;
        }
        .submit-btn {
          width: 100%;
          margin-top: 5px;
        }
        .user-message {
          margin-left: 10%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1><span style="background: -webkit-linear-gradient(left, var(--color-accent-purple), var(--color-accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
        AGENT EDUCATION PLATFORM
      </span></h1>
      <p class="intro-text">
        Decentralized Learning Interface. Engage your Autonomous Education Agent via the console below.
      </p>

      <div id="chat-area">
        <div class="message-box message-success">
          [SYSTEM] Connection Established. Ensure all four agents are active.
        </div>
      </div>

      <form id="input-form">
        <input
          type="text"
          id="user_input"
          name="user_input"
          class="user-input"
          placeholder="Enter command or answer (e.g., '1', 'A', 'Math:Beginner')..."
          required
        />
        <button type="submit" class="submit-btn">SEND</button>
      </form>
    </div>

    <script>
      // Classify message based on content for color styling
      function classifyMessage(msg, isResponseOk) {
        const s = String(msg || "");
        if (/✅|\bCorrect\b|Correct Answer|\bcorrect\b/i.test(s)) return 'message-success';
        if (/❌|\bIncorrect\b|Incorrect Answer|\bincorrect\b/i.test(s)) return 'message-wrong';
        if (/Question:|\bQuestion\b|\bQ:\b/i.test(s)) return 'message-question';
        // Fallback for UI Status based on fetch result
        if (s.startsWith('[UI Status]') && !isResponseOk) return 'message-error';
        // General messages from system or tutor
        return 'message-system'; 
      }

      document
        .getElementById("input-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const inputField = document.getElementById("user_input");
          const userInput = inputField.value;
          const chatArea = document.getElementById("chat-area");

          // Display user input
          chatArea.innerHTML += `<div class="message-box user-message">**You:** ${userInput}</div>`;
          chatArea.scrollTop = chatArea.scrollHeight;
          inputField.value = "";

          // CRITICAL: Send JSON data to Flask with the 'user_input' key
          const payload = { 'user_input': userInput }; 

          try {
            const response = await fetch("/submit_input", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
            
            const responseOk = response.ok;
            const result = await response.json();

            // Show high-level status
            const uiMessage = result.message || (responseOk ? "Success" : "Error");
            const statusClass = classifyMessage(`[UI Status] ${uiMessage}`, responseOk);
            chatArea.innerHTML += `<div class="message-box ${statusClass}">[UI Status] ${uiMessage}</div>`;

            // If the backend included an agent_response, try to parse and display it.
            if (result.agent_response) {
              try {
                let ar = result.agent_response;
                if (typeof ar === "string") {
                  try {
                    ar = JSON.parse(ar);
                  } catch (e) {} // leave as raw string
                }

                let agentMsg = "";
                if (ar && typeof ar === "object") {
                  agentMsg = ar.message || JSON.stringify(ar);
                } else {
                  agentMsg = String(ar);
                }
                
                // Classify ack message
                const ackClass = classifyMessage(agentMsg, responseOk);
                chatArea.innerHTML += `<div class="message-box ${ackClass}">[Student Ack] ${agentMsg}</div>`;
              } catch (e) {
                chatArea.innerHTML += `<div class="message-box message-error">[UI Error] Could not parse agent_response.</div>`;
              }
            }

            // Display recent terminal outputs (Tutor responses)
            const displayedOutputs = new Set();
            function renderOutputs(outputs) {
              if (!outputs) return;
              if (Array.isArray(outputs) && outputs.length) {
                outputs.forEach(o => {
                  if (!displayedOutputs.has(o)) {
                    displayedOutputs.add(o);
                    const cls = classifyMessage(o, responseOk);
                    chatArea.innerHTML += `<div class="message-box ${cls}">${o}</div>`; 
                  }
                });
              } else if (typeof outputs === 'string' && outputs.trim()) {
                if (!displayedOutputs.has(outputs)) {
                  displayedOutputs.add(outputs);
                  const cls = classifyMessage(outputs, responseOk);
                  chatArea.innerHTML += `<div class="message-box ${cls}">${outputs}</div>`; 
                }
              }
            }

            try {
              renderOutputs(result.recent_outputs);
            } catch (e) {}

            // Start short-polling the Flask /recent_fetch endpoint for delayed tutor responses.
            (function pollRecentForAWhile() {
              let attempts = 0;
              const maxAttempts = 8;
              const interval = 700;
              const timer = setInterval(async () => {
                attempts += 1;
                try {
                  const r = await fetch('/recent_fetch');
                  const j = await r.json();
                  const outputs = j.outputs || j;
                  renderOutputs(outputs);
                } catch (err) {
                  // ignore network errors during polling
                }
                if (attempts >= maxAttempts) clearInterval(timer);
              }, interval);
            })();

            // Helpful reminder where the main agent console output appears
            chatArea.innerHTML += `<div class="message-box message-system">[Console Tip] Check the <code>student_agent.py</code> terminal for the agent's full state and menu!</div>`;
          } catch (error) {
            chatArea.innerHTML += `<div class="message-box message-error">[Network Error] Could not connect to the Flask server or parse response.</div>`;
          }
          chatArea.scrollTop = chatArea.scrollHeight;
        });
    </script>
  </body>
</html>


